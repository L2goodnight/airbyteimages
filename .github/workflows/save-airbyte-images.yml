name: Save Airbyte Images (4-core-batch)

on:
  workflow_dispatch:

env:
  AIRBYTE_TAG: 2.0.1

jobs:
  save:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          sudo docker image prune -af
          df -h

      - name: Pull & save & upload (4 images)
        run: |
          images=(
            airbyte/bootloader:2.0.1
            airbyte/server:2.0.1
            airbyte/worker:2.0.1
            airbyte/cron:2.0.1
          )
          mkdir -p images
          for img in "${images[@]}"; do
            echo ">>> Pull $img"
            docker pull "$img:${{ env.AIRBYTE_TAG }}"
            file=$(basename "$img")-${{ env.AIRBYTE_TAG }}.tar
            echo ">>> Save $img -> images/$file"
            docker save "$img:${{ env.AIRBYTE_TAG }}" > "images/$file"
            docker image prune -af   # 立即清镜像
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: airbyte-core-${{ env.AIRBYTE_TAG }}
          path: images/*.tar
          retention-days: 30
