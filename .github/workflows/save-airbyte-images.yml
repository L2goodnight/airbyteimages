name: Batch1 - Core images

on:
  workflow_dispatch:

env:
  TAG: 2.0.1

jobs:
  pack:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          sudo docker image prune -af
          df -h

      - name: Pull & save & upload
        run: |
          list=(
            airbyte/bootloader:2.0.1
            airbyte/server:2.0.1
            airbyte/worker:2.0.1
            airbyte/cron:2.0.1
          )
          for img in "${list[@]}"; do
            file=$(basename "$img")-${TAG}.tar
            docker pull "$img:$TAG"
            docker save "$img:$TAG" > "$file"
            docker image prune -af
          done
          # 统一上传
          find . -name "*.tar" -exec echo "FILE={}" \; >> $GITHUB_ENV

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: batch1-core-${{ env.TAG }}
          path: "*.tar"
          retention-days: 30
